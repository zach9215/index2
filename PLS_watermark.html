<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>水印添加工具</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root{--primary-color:#3498db;--secondary-color:#2980b9;--accent-color:#e74c3c;--success-color:#2ecc71;--light-color:#ecf0f1;--dark-color:#2c3e50;--warning-color:#f39c12}*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}body{background:linear-gradient(135deg,#e3f2fd 0%,#bbdefb 100%);min-height:100vh;padding:20px;color:var(--dark-color)}.container{max-width:1400px;margin:0 auto}.back-to-home{position:absolute;top:15px;left:15px;padding:8px 15px;background:rgba(52,152,219,.1);color:#2c3e50;border:1px solid rgba(52,152,219,.3);border-radius:20px;cursor:pointer;z-index:100;transition:all .3s ease;font-size:.9rem;text-decoration:none;display:flex;align-items:center}.back-to-home:hover{background:rgba(52,152,219,.2);transform:translateY(-2px);box-shadow:0 2px 5px rgba(0,0,0,.1)}.back-to-home i{margin-right:5px;color:#2c3e50}header{text-align:center;margin-bottom:30px;padding:25px;background:rgba(255,255,255,.9);border-radius:15px;box-shadow:0 5px 20px rgba(0,0,0,.1);position:relative}h1{color:var(--dark-color);margin-bottom:10px;font-size:2.8rem;text-shadow:1px 1px 3px rgba(0,0,0,.1)}.subtitle{color:var(--secondary-color);font-size:1.3rem;max-width:700px;margin:0 auto 20px;line-height:1.6}.app-container{display:flex;flex-wrap:wrap;gap:30px;background:#fff;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,.15);padding:30px;margin-bottom:30px}.upload-section,.preview-section{flex:1;min-width:320px;padding:15px}.preview-section{flex:1.5;min-width:450px}.section-title{font-size:1.6rem;margin-bottom:25px;color:var(--secondary-color);padding-bottom:12px;border-bottom:2px solid var(--light-color);display:flex;align-items:center}.section-title i{margin-right:12px;font-size:1.4rem;color:var(--primary-color)}.upload-area{border:2px dashed var(--primary-color);border-radius:12px;padding:45px 20px;text-align:center;background-color:rgba(52,152,219,.05);transition:all .3s ease;cursor:pointer;margin-bottom:25px;position:relative;overflow:hidden}.upload-area:hover{background-color:rgba(52,152,219,.1);transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,.1)}.upload-icon{font-size:4.5rem;color:var(--primary-color);margin-bottom:18px;animation:float 3s ease-in-out infinite}@keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-10px)}100%{transform:translateY(0)}}.file-input{display:none}.file-info{margin-top:20px;padding:18px;background-color:var(--light-color);border-radius:10px;display:none;transition:all .3s;border-left:4px solid var(--primary-color)}.file-info p{margin-bottom:8px;display:flex;align-items:center}.file-info i{width:24px;color:var(--primary-color);margin-right:10px}.watermark-controls{margin-top:30px}.control-group{margin-bottom:22px;background:#f9f9f9;padding:20px;border-radius:12px;box-shadow:0 3px 10px rgba(0,0,0,.04);border:1px solid #eee}label{display:block;margin-bottom:12px;font-weight:600;color:var(--dark-color);display:flex;align-items:center;font-size:1.05rem}label i{margin-right:10px;color:var(--primary-color);font-size:1.2rem;min-width:24px}input[type=text],input[type=range],input[type=color],select{width:100%;padding:14px 18px;border:1px solid #ddd;border-radius:10px;font-size:1.05rem;background:#fff;transition:all .3s;-webkit-appearance:none;-moz-appearance:none;appearance:none}input[type=text]:focus,select:focus{border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(52,152,219,.25);outline:none}input[type=range]{padding:0;height:10px;background:#e0e0e0;border-radius:5px;-webkit-appearance:none}input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:24px;height:24px;border-radius:50%;background:var(--primary-color);cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.2);border:2px solid #fff}input[type=range]::-moz-range-thumb{width:24px;height:24px;border-radius:50%;background:var(--primary-color);cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.2);border:2px solid #fff}.range-container{display:flex;align-items:center;gap:18px;margin-top:10px}.range-value{display:inline-block;min-width:65px;text-align:center;font-weight:bold;background:var(--light-color);padding:8px 15px;border-radius:8px;font-size:1.05rem;border:1px solid #ddd}.preview-container{width:100%;height:450px;border:1px solid #ddd;border-radius:12px;overflow:hidden;margin-bottom:25px;position:relative;background:linear-gradient(45deg,#f0f0f0 25%,transparent 0,transparent 75%,#f0f0f0 0),linear-gradient(45deg,#f0f0f0 25%,transparent 0,transparent 75%,#f0f0f0 0);background-size:20px 20px;background-position:0 0,10px 10px;box-shadow:0 5px 15px rgba(0,0,0,.08)}#previewCanvas{display:block;max-width:100%;max-height:100%;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff}.no-file{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:#aaa;width:100%;padding:20px}.btn{display:inline-flex;align-items:center;justify-content:center;padding:14px 28px;background-color:var(--primary-color);color:#fff;border:none;border-radius:10px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all .3s ease;text-align:center;text-decoration:none;box-shadow:0 4px 8px rgba(0,0,0,.15)}.btn i{margin-right:10px;font-size:1.2rem}.btn:hover{background-color:var(--secondary-color);transform:translateY(-3px);box-shadow:0 6px 15px rgba(0,0,0,.2)}.btn:active{transform:translateY(-1px);box-shadow:0 3px 8px rgba(0,0,0,.15)}.btn-download{background-color:var(--success-color);width:100%;margin-top:15px;padding:16px;font-size:1.15rem}.btn-download:hover{background-color:#27ae60}.btn-reset{background-color:var(--accent-color)}.btn-reset:hover{background-color:#c0392b}.button-group{display:flex;gap:15px;margin-top:30px;flex-wrap:wrap}.position-controls{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:15px}.position-btn{padding:14px 5px;background:#f1f1f1;border:1px solid #ddd;border-radius:10px;cursor:pointer;text-align:center;transition:all .2s;font-size:1.4rem;display:flex;align-items:center;justify-content:center}.position-btn:hover,.position-btn.active{background-color:var(--primary-color);color:#fff;border-color:var(--primary-color);transform:scale(1.05)}footer{text-align:center;padding:25px;color:var(--dark-color);font-size:1rem;background:rgba(255,255,255,.85);border-radius:12px;box-shadow:0 5px 15px rgba(0,0,0,.08)}.logo-preview{width:100px;height:100px;border:1px dashed #ccc;border-radius:8px;margin-top:10px;display:flex;align-items:center;justify-content:center;overflow:hidden;background-color:#f9f9f9}.logo-preview img{max-width:100%;max-height:100%}.tab-controls{display:flex;gap:10px;margin-bottom:20px;border-bottom:2px solid #eee;padding-bottom:10px}.tab-btn{padding:10px 20px;background:#f1f1f1;border:none;border-radius:6px;cursor:pointer;font-weight:600;transition:all .3s}.tab-btn.active{background-color:var(--primary-color);color:#fff}.tab-content{display:none}.tab-content.active{display:block}.logo-controls{display:flex;gap:15px;flex-wrap:wrap}.logo-control-group{flex:1;min-width:200px}.logo-upload-btn{display:block;padding:12px;background:var(--primary-color);color:#fff;border:none;border-radius:8px;cursor:pointer;text-align:center;margin-top:10px;transition:all .3s}.logo-upload-btn:hover{background:var(--secondary-color)}select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%233498db' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 18px center;background-size:14px;padding-right:50px}.format-selection{display:flex;align-items:center;margin-bottom:15px;background:#f9f9f9;padding:15px;border-radius:10px}.format-selection label{margin:0 15px 0 0;font-weight:600;color:var(--dark-color)}.format-selection select{flex:1;max-width:200px}.pdf-quality{display:flex;align-items:center;margin-top:10px;background:rgba(46,204,113,.1);padding:12px;border-radius:8px;border-left:4px solid var(--success-color)}.pdf-quality i{margin-right:10px;color:var(--success-color);font-size:1.2rem}@media (max-width:992px){.app-container{flex-direction:column}.upload-section,.preview-section{min-width:100%}h1{font-size:2.3rem}.subtitle{font-size:1.15rem}}@media (max-width:576px){.position-controls{gap:8px}.position-btn{padding:12px 5px;font-size:1.2rem}.button-group{flex-direction:column}.btn{width:100%;justify-content:center}.logo-controls{flex-direction:column}.format-selection{flex-direction:column;align-items:flex-start}.format-selection select{max-width:100%;margin-top:10px}}.download-controls{margin-top:30px;padding-top:30px;border-top:1px solid #eee}.progress-container{margin-top:15px;background:#f1f1f1;border-radius:8px;overflow:hidden;display:none}.progress-bar{height:24px;background:linear-gradient(90deg,#3498db,#2ecc71);width:0%;transition:width .3s;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:bold}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" class="back-to-home"><i class="fas fa-arrow-left"></i> 返回导航</a>
            <h1><i class="fas fa-water"></i> 水印添加工具</h1>
            <p class="subtitle">可添加文字或Logo水印，支持高清图片和PDF导出<br>目前仅支持处理单页文件</p>
        </header>
        
        <div class="app-container">
            <div class="upload-section">
                <h2 class="section-title"><i class="fas fa-upload"></i> 上传文件</h2>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                    <h3>点击或拖拽文件到此处</h3>
                    <p>支持格式: JPG, PNG</p>
                    <p>最大文件大小: 5MB</p>
                    <input type="file" id="fileInput" class="file-input" accept=".jpg,.jpeg,.png">
                </div>
                
                <div class="file-info" id="fileInfo">
                    <p><i class="fas fa-file"></i> <strong>文件名:</strong> <span id="fileName">-</span></p>
                    <p><i class="fas fa-image"></i> <strong>文件类型:</strong> <span id="fileType">-</span></p>
                    <p><i class="fas fa-weight-hanging"></i> <strong>文件大小:</strong> <span id="fileSize">-</span></p>
                </div>
                
                <div class="watermark-controls">
                    <div class="tab-controls">
                        <button class="tab-btn active" data-tab="text">文字水印</button>
                        <button class="tab-btn" data-tab="logo">Logo水印</button>
                    </div>
                    
                    <div class="tab-content active" id="textTab">
                        <h2 class="section-title"><i class="fas fa-font"></i> 文字水印设置</h2>
                        
                        <div class="control-group">
                            <label for="watermarkText"><i class="fas fa-font"></i> 水印文本</label>
                            <input type="text" id="watermarkText" value="机密文件 - 请勿外传" placeholder="输入水印文本">
                        </div>
                        
                        <div class="control-group">
                            <label for="fontSize"><i class="fas fa-text-height"></i> 字体大小</label>
                            <div class="range-container">
                                <input type="range" id="fontSize" min="10" max="300" value="40">
                                <span id="fontSizeValue" class="range-value">40px</span>
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <label for="textColor"><i class="fas fa-palette"></i> 文字颜色</label>
                            <input type="color" id="textColor" value="#808080">
                        </div>
                        
                        <div class="control-group">
                            <label for="opacity"><i class="fas fa-adjust"></i> 透明度</label>
                            <div class="range-container">
                                <input type="range" id="opacity" min="0.1" max="1" step="0.1" value="0.6">
                                <span id="opacityValue" class="range-value">0.6</span>
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <label for="watermarkType"><i class="fas fa-layer-group"></i> 水印类型</label>
                            <select id="watermarkType">
                                <option value="single">单个水印</option>
                                <option value="diagonal">对角双水印</option>
                                <option value="tiled" selected>平铺水印</option>
                                <option value="border">边框水印</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="logoTab">
                        <h2 class="section-title"><i class="fas fa-image"></i> Logo水印设置</h2>
                        
                        <div class="control-group">
                            <label for="logoInput"><i class="fas fa-upload"></i> 上传Logo</label>
                            <input type="file" id="logoInput" class="file-input" accept=".png,.jpg,.jpeg,.svg">
                            <button class="logo-upload-btn" id="logoUploadBtn"><i class="fas fa-upload"></i> 选择Logo文件</button>
                            <div class="logo-preview" id="logoPreview">
                                <i class="fas fa-image" style="font-size:2rem;color:#ccc"></i>
                                <span style="font-size:.9rem;margin-top:5px">Logo预览</span>
                            </div>
                        </div>
                        
                        <div class="logo-controls">
                            <div class="logo-control-group">
                                <div class="control-group">
                                    <label for="logoSize"><i class="fas fa-expand"></i> Logo大小</label>
                                    <div class="range-container">
                                        <input type="range" id="logoSize" min="10" max="200" value="100">
                                        <span id="logoSizeValue" class="range-value">100%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="logo-control-group">
                                <div class="control-group">
                                    <label for="logoOpacity"><i class="fas fa-adjust"></i> 透明度</label>
                                    <div class="range-container">
                                        <input type="range" id="logoOpacity" min="0.1" max="1" step="0.1" value="0.8">
                                        <span id="logoOpacityValue" class="range-value">0.8</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="preview-section">
                <h2 class="section-title"><i class="fas fa-eye"></i> 预览效果</h2>
                
                <div class="preview-container">
                    <div class="no-file" id="noFileMessage">
                        <i class="fas fa-image" style="font-size:4rem;margin-bottom:20px;color:#e0e0e0"></i>
                        <h3>尚未上传图片</h3>
                        <p>请上传图片以预览水印效果</p>
                    </div>
                    <canvas id="previewCanvas"></canvas>
                </div>
                
                <div class="format-selection">
                    <label for="formatSelect"><i class="fas fa-file-download"></i> 输出格式:</label>
                    <select id="formatSelect">
                        <option value="image">图片 (JPG)</option>
                        <option value="pdf">PDF (高清)</option>
                    </select>
                </div>

                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar" id="progressBar">0%</div>
                </div>
                
                <button class="btn btn-download" id="downloadBtn"><i class="fas fa-download"></i> 下载添加水印的文件</button>
                
                <div class="pdf-quality">
                    <i class="fas fa-info-circle"></i>
                    <span>PDF输出使用原始图像质量，确保高清效果</span>
                </div>
                
                <div class="download-controls">
                    <div class="control-group">
                        <label><i class="fas fa-arrows-alt"></i> 水印位置</label>
                        <div class="position-controls">
                            <div class="position-btn" data-position="top-left">↖</div>
                            <div class="position-btn" data-position="top-center">↑</div>
                            <div class="position-btn" data-position="top-right">↗</div>
                            <div class="position-btn" data-position="middle-left">←</div>
                            <div class="position-btn active" data-position="center">中心</div>
                            <div class="position-btn" data-position="middle-right">→</div>
                            <div class="position-btn" data-position="bottom-left">↙</div>
                            <div class="position-btn" data-position="bottom-center">↓</div>
                            <div class="position-btn" data-position="bottom-right">↘</div>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label for="rotation"><i class="fas fa-sync"></i> 旋转角度</label>
                        <div class="range-container">
                            <input type="range" id="rotation" min="0" max="360" value="30">
                            <span id="rotationValue" class="range-value">30°</span>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn" id="applyBtn"><i class="fas fa-magic"></i> 应用水印</button>
                        <button class="btn btn-reset" id="resetBtn"><i class="fas fa-redo"></i> 重置</button>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>© 2025 判理社 <br>水印添加工具 | 支持文字和Logo水印</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const logoInput = document.getElementById('logoInput');
            const logoUploadBtn = document.getElementById('logoUploadBtn');
            const uploadArea = document.getElementById('uploadArea');
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileType = document.getElementById('fileType');
            const fileSize = document.getElementById('fileSize');
            const watermarkText = document.getElementById('watermarkText');
            const fontSize = document.getElementById('fontSize');
            const fontSizeValue = document.getElementById('fontSizeValue');
            const opacity = document.getElementById('opacity');
            const opacityValue = document.getElementById('opacityValue');
            const textColor = document.getElementById('textColor');
            const rotation = document.getElementById('rotation');
            const rotationValue = document.getElementById('rotationValue');
            const watermarkType = document.getElementById('watermarkType');
            const logoSize = document.getElementById('logoSize');
            const logoSizeValue = document.getElementById('logoSizeValue');
            const logoOpacity = document.getElementById('logoOpacity');
            const logoOpacityValue = document.getElementById('logoOpacityValue');
            const applyBtn = document.getElementById('applyBtn');
            const resetBtn = document.getElementById('resetBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const noFileMessage = document.getElementById('noFileMessage');
            const positionButtons = document.querySelectorAll('.position-btn');
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            const logoPreview = document.getElementById('logoPreview');
            const formatSelect = document.getElementById('formatSelect');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const canvas = document.getElementById('previewCanvas');
            const ctx = canvas.getContext('2d');
            let currentFile = null;
            let currentImage = new Image();
            let logoImage = null;
            let watermarkPosition = 'center';
            let activeTab = 'text';
            
            fontSize.addEventListener('input', function() { fontSizeValue.textContent = this.value + 'px'; });
            opacity.addEventListener('input', function() { opacityValue.textContent = this.value; });
            rotation.addEventListener('input', function() { rotationValue.textContent = this.value + '°'; });
            logoSize.addEventListener('input', function() { logoSizeValue.textContent = this.value + '%'; });
            logoOpacity.addEventListener('input', function() { logoOpacityValue.textContent = this.value; });
            
            positionButtons.forEach(button => {
                button.addEventListener('click', function() {
                    positionButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    watermarkPosition = this.dataset.position;
                    if (currentFile) applyWatermark();
                });
            });
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tab = this.dataset.tab;
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === tab + 'Tab') content.classList.add('active');
                    });
                    activeTab = tab;
                    if (currentFile) applyWatermark();
                });
            });
            
            uploadArea.addEventListener('click', () => fileInput.click());
            logoUploadBtn.addEventListener('click', () => logoInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.backgroundColor = 'rgba(52, 152, 219, 0.15)';
                uploadArea.style.transform = 'translateY(-5px)';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.backgroundColor = 'rgba(52, 152, 219, 0.05)';
                uploadArea.style.transform = 'translateY(0)';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.backgroundColor = 'rgba(52, 152, 219, 0.05)';
                uploadArea.style.transform = 'translateY(0)';
                if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
            });
            
            logoInput.addEventListener('change', (e) => { if (e.target.files.length) handleLogo(e.target.files[0]); });
            fileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0]); });
            
            function handleFile(file) {
                const validTypes = ['image/jpeg', 'image/png'];
                if (!validTypes.includes(file.type)) {
                    alert('请上传 JPG 或 PNG 图片文件');
                    return;
                }
                if (file.size > 5 * 1024 * 1024) {
                    alert('文件大小超过 5MB 限制');
                    return;
                }
                currentFile = file;
                fileName.textContent = file.name;
                fileType.textContent = file.type.split('/')[1].toUpperCase();
                fileSize.textContent = (file.size / 1024).toFixed(2) + ' KB';
                fileInfo.style.display = 'block';
                previewFile(file);
            }
            
            function handleLogo(file) {
                const validTypes = ['image/jpeg', 'image/png', 'image/svg+xml'];
                if (!validTypes.includes(file.type)) {
                    alert('请上传 JPG、PNG 或 SVG 文件');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        logoImage = img;
                        logoPreview.innerHTML = '';
                        const previewImg = document.createElement('img');
                        previewImg.src = img.src;
                        logoPreview.appendChild(previewImg);
                        if (currentFile && activeTab === 'logo') applyWatermark();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
            
            function previewFile(file) {
                noFileMessage.style.display = 'none';
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentImage.onload = function() {
                        canvas.width = currentImage.width;
                        canvas.height = currentImage.height;
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
                        applyWatermark();
                    };
                    currentImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
            
            function applyWatermark() {
                if (!currentFile) return;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
                if (activeTab === 'text') applyTextWatermark();
                else if (activeTab === 'logo' && logoImage) applyLogoWatermark();
            }
            
            function applyTextWatermark() {
                const fontSizeVal = parseInt(fontSize.value);
                const opacityVal = parseFloat(opacity.value);
                const rotationVal = parseInt(rotation.value);
                const text = watermarkText.value || '机密文件';
                const rgb = hexToRgb(textColor.value);
                ctx.fillStyle = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${opacityVal})`;
                ctx.font = `bold ${fontSizeVal}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const type = watermarkType.value;
                switch(type) {
                    case 'single': addSingleWatermark(text, fontSizeVal, rotationVal); break;
                    case 'diagonal': addDiagonalWatermarks(text, fontSizeVal, rotationVal); break;
                    case 'tiled': addTiledWatermarks(text, fontSizeVal, rotationVal); break;
                    case 'border': addBorderWatermarks(text, fontSizeVal, rotationVal); break;
                }
            }
            
            function applyLogoWatermark() {
                const sizePercent = parseInt(logoSize.value) / 100;
                const opacityVal = parseFloat(logoOpacity.value);
                const rotationVal = parseInt(rotation.value);
                const logoWidth = logoImage.width * sizePercent;
                const logoHeight = logoImage.height * sizePercent;
                let x, y;
                switch(watermarkPosition) {
                    case 'top-left': x = canvas.width * 0.1; y = canvas.height * 0.1; break;
                    case 'top-center': x = canvas.width / 2; y = canvas.height * 0.1; break;
                    case 'top-right': x = canvas.width * 0.9; y = canvas.height * 0.1; break;
                    case 'middle-left': x = canvas.width * 0.1; y = canvas.height / 2; break;
                    case 'center': x = canvas.width / 2; y = canvas.height / 2; break;
                    case 'middle-right': x = canvas.width * 0.9; y = canvas.height / 2; break;
                    case 'bottom-left': x = canvas.width * 0.1; y = canvas.height * 0.9; break;
                    case 'bottom-center': x = canvas.width / 2; y = canvas.height * 0.9; break;
                    case 'bottom-right': x = canvas.width * 0.9; y = canvas.height * 0.9; break;
                }
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(rotationVal * Math.PI / 180);
                ctx.globalAlpha = opacityVal;
                ctx.drawImage(logoImage, -logoWidth/2, -logoHeight/2, logoWidth, logoHeight);
                ctx.restore();
            }
            
            function addSingleWatermark(text, fontSize, rotation) {
                ctx.save();
                let x, y;
                switch(watermarkPosition) {
                    case 'top-left': x = Math.max(fontSize, canvas.width * 0.1); y = Math.max(fontSize, canvas.height * 0.1); break;
                    case 'top-center': x = canvas.width / 2; y = Math.max(fontSize, canvas.height * 0.1); break;
                    case 'top-right': x = Math.min(canvas.width - fontSize, canvas.width * 0.9); y = Math.max(fontSize, canvas.height * 0.1); break;
                    case 'middle-left': x = Math.max(fontSize, canvas.width * 0.1); y = canvas.height / 2; break;
                    case 'center': x = canvas.width / 2; y = canvas.height / 2; break;
                    case 'middle-right': x = Math.min(canvas.width - fontSize, canvas.width * 0.9); y = canvas.height / 2; break;
                    case 'bottom-left': x = Math.max(fontSize, canvas.width * 0.1); y = Math.min(canvas.height - fontSize, canvas.height * 0.9); break;
                    case 'bottom-center': x = canvas.width / 2; y = Math.min(canvas.height - fontSize, canvas.height * 0.9); break;
                    case 'bottom-right': x = Math.min(canvas.width - fontSize, canvas.width * 0.9); y = Math.min(canvas.height - fontSize, canvas.height * 0.9); break;
                }
                ctx.translate(x, y);
                ctx.rotate(rotation * Math.PI / 180);
                ctx.fillText(text, 0, 0);
                ctx.restore();
            }
            
            function addDiagonalWatermarks(text, fontSize, rotation) {
                ctx.save();
                ctx.translate(Math.max(fontSize, canvas.width * 0.1), Math.max(fontSize, canvas.height * 0.1));
                ctx.rotate(rotation * Math.PI / 180);
                ctx.fillText(text, 0, 0);
                ctx.restore();
                ctx.save();
                ctx.translate(Math.min(canvas.width - fontSize, canvas.width * 0.9), Math.min(canvas.height - fontSize, canvas.height * 0.9));
                ctx.rotate(rotation * Math.PI / 180);
                ctx.fillText(text, 0, 0);
                ctx.restore();
            }
            
            function addTiledWatermarks(text, fontSize, rotation) {
                const textWidth = ctx.measureText(text).width;
                const spacingX = textWidth * 3.5;
                const spacingY = fontSize * 5.5;
                const startX = -spacingX + (canvas.width % spacingX)/2;
                const startY = -spacingY + (canvas.height % spacingY)/2;
                ctx.save();
                for (let x = startX; x < canvas.width + spacingX; x += spacingX) {
                    for (let y = startY; y < canvas.height + spacingY; y += spacingY) {
                        ctx.save();
                        ctx.translate(x, y);
                        ctx.rotate(rotation * Math.PI / 180);
                        ctx.fillText(text, 0, 0);
                        ctx.restore();
                    }
                }
                ctx.restore();
            }
            
            function addBorderWatermarks(text, fontSize, rotation) {
                const textWidth = ctx.measureText(text).width;
                const spacing = textWidth * 1.5;
                ctx.save();
                for (let x = 0; x < canvas.width; x += spacing) {
                    ctx.save();
                    ctx.translate(Math.min(canvas.width - textWidth/2, x + textWidth/2), Math.max(fontSize * 1.5, 20));
                    ctx.rotate(rotation * Math.PI / 180);
                    ctx.fillText(text, 0, 0);
                    ctx.restore();
                }
                for (let x = 0; x < canvas.width; x += spacing) {
                    ctx.save();
                    ctx.translate(Math.min(canvas.width - textWidth/2, x + textWidth/2), Math.min(canvas.height - fontSize * 1.5, canvas.height - 20));
                    ctx.rotate(rotation * Math.PI / 180);
                    ctx.fillText(text, 0, 0);
                    ctx.restore();
                }
                for (let y = fontSize*3; y < canvas.height - fontSize*3; y += spacing) {
                    ctx.save();
                    ctx.translate(Math.max(textWidth * 1.2, 20), y);
                    ctx.rotate((rotation + 90) * Math.PI / 180);
                    ctx.fillText(text, 0, 0);
                    ctx.restore();
                }
                for (let y = fontSize*3; y < canvas.height - fontSize*3; y += spacing) {
                    ctx.save();
                    ctx.translate(Math.min(canvas.width - textWidth * 1.2, canvas.width - 20), y);
                    ctx.rotate((rotation + 90) * Math.PI / 180);
                    ctx.fillText(text, 0, 0);
                    ctx.restore();
                }
                ctx.restore();
            }
            
            function hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? { r: parseInt(result[1],16), g: parseInt(result[2],16), b: parseInt(result[3],16) } : { r:0, g:0, b:0 };
            }
            
            applyBtn.addEventListener('click', applyWatermark);
            watermarkType.addEventListener('change', function() { if (currentFile) applyWatermark(); });
            
            resetBtn.addEventListener('click', function() {
                if (currentFile) {
                    previewFile(currentFile);
                    watermarkText.value = "机密文件 - 请勿外传";
                    fontSize.value = 40;
                    fontSizeValue.textContent = "40px";
                    opacity.value = 0.6;
                    opacityValue.textContent = "0.6";
                    textColor.value = "#808080";
                    rotation.value = 30;
                    rotationValue.textContent = "30°";
                    watermarkType.value = "tiled";
                    positionButtons.forEach(btn => {
                        if (btn.dataset.position === 'center') {
                            btn.classList.add('active');
                            watermarkPosition = 'center';
                        } else btn.classList.remove('active');
                    });
                }
                logoSize.value = 100;
                logoSizeValue.textContent = "100%";
                logoOpacity.value = 0.8;
                logoOpacityValue.textContent = "0.8";
                logoPreview.innerHTML = '<i class="fas fa-image" style="font-size:2rem;color:#ccc"></i><span style="font-size:.9rem;margin-top:5px">Logo预览</span>';
                logoImage = null;
            });
            
            downloadBtn.addEventListener('click', async function() {
                if (!currentFile) { alert('请先上传文件'); return; }
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';
                const format = formatSelect.value;
                let blob, filename;
                try {
                    if (format === 'image') {
                        progressBar.style.width = '30%';
                        progressBar.textContent = '30%';
                        blob = await new Promise((resolve, reject) => {
                            canvas.toBlob(function(blob) {
                                blob ? resolve(blob) : reject(new Error('Canvas to Blob conversion failed'));
                            }, 'image/jpeg', 0.92);
                        });
                        filename = `watermarked_${currentFile.name.replace(/\.[^/.]+$/, "")}.jpg`;
                    } else if (format === 'pdf') {
                        progressBar.style.width = '30%';
                        progressBar.textContent = '30%';
                        blob = createPDF();
                        filename = `watermarked_${currentFile.name.replace(/\.[^/.]+$/, "")}.pdf`;
                    } else { alert('不支持的格式'); return; }
                    progressBar.style.width = '60%';
                    progressBar.textContent = '60%';
                    const zip = new JSZip();
                    const folderName = "水印文件";
                    zip.folder(folderName).file(filename, blob);
                    progressBar.style.width = '80%';
                    progressBar.textContent = '80%';
                    const zipBlob = await zip.generateAsync({
                        type:"blob",
                        compression: "DEFLATE",
                        compressionOptions: { level: 9 }
                    }, metadata => {
                        progressBar.style.width = `${80 + Math.floor(metadata.percent/5)}%`;
                        progressBar.textContent = `${80 + Math.floor(metadata.percent/5)}%`;
                    });
                    progressBar.style.width = '100%';
                    progressBar.textContent = '100%';
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(zipBlob);
                    link.href = url;
                    link.download = `水印文件_${currentFile.name.replace(/\.[^/.]+$/, "")}.zip`;
                    document.body.appendChild(link);
                    link.click();
                    setTimeout(() => {
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                        progressContainer.style.display = 'none';
                    }, 1000);
                } catch (error) {
                    console.error('下载失败:', error);
                    alert('下载失败: ' + error.message);
                    progressContainer.style.display = 'none';
                }
            });
            
            function createPDF() {
                const now = new Date();
                const dateStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: canvas.width > canvas.height ? 'landscape' : 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                const imgData = canvas.toDataURL('image/jpeg', 1.0);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                let imgWidth = canvas.width;
                let imgHeight = canvas.height;
                const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
                imgWidth *= ratio * 0.95;
                imgHeight *= ratio * 0.95;
                const x = (pdfWidth - imgWidth) / 2;
                const y = (pdfHeight - imgHeight) / 2;
                pdf.addImage(imgData, 'JPEG', x, y, imgWidth, imgHeight);
                pdf.setFontSize(10);
                pdf.text(`水印工具生成 - ${dateStr}`, pdfWidth - 50, pdfHeight - 10);
                return pdf.output('blob');
            }
            
            fontSizeValue.textContent = fontSize.value + 'px';
            opacityValue.textContent = opacity.value;
            rotationValue.textContent = rotation.value + '°';
            logoSizeValue.textContent = logoSize.value + '%';
            logoOpacityValue.textContent = logoOpacity.value;
        });
    </script>
</body>
</html>